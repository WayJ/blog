# 平安通标品开发框架的概要设计

# 一、引言

## 1.1 简述

这将会是一个更好的平安通。

## 1.2 目的

技术栈统一，可复用，高效

### 1.2.1 需求来源

本产品是解决方案开发部的综治系统基线版本的移动端部分。

其余需求来自上级领导和产品。

### 1.2.2 需求收集

1. 能够应对2020年解决方案开发部的交付需求
2. 尽量考虑将运营省份的平安通升级到该版本
3. 该app不能用以前的拉分支的方式来完成交付
4. 技术栈统一+复用
5. 技术成果能够积累
6. 业务应用（原来的业务模块）可以复用
7. 以标品方案开发的应用，如何在原有平安通上运行，运行环境的差异

## 1.3 背景

### 1.3.1 平安通现状

平安通现有近70个交付项目与5个运营省份（浙江、四川、江苏、广东、广西）

现有平安通app都是以原生开发的方式完成的。

浙江平安通使用了插件化的架构。

大部分现有的业务模块都是包含在一个个的平安通app中，不是独立的，与具体地区的平安通app 强耦合。

19年底开发了少量的多端项目，其中使用了一些各端的api，大部分无法直接在其他端上直接使用，需要少量的额外适配工作。

### **1.3.2 项目背景**

营收目标Up！

效能Up！

复用Up！

## 1.4 术语和定义

**组件**：能够复用的代码单元

**微应用**：独立开发的业务模块，变成一个个小的微应用，与平安通app进行了解藕，能够运行在平安通的容器中或者以多端的形式运行在各端中。

**容器：**应用容器有多种，包含H5容器或者原生插件容器，是能够让H5页面、多端项目、原生插件运行起来的环境。

**无线云平台：**无线云平台······。

**基础业务数据：**包含了用户信息、用户权限、数据字典、组织机构这四项综治系统中的常见基础数据。

## 1.5 角色

角色、需求目标、衡量标准

- 标品团队：即开发本方案的开发团队，目前有移动端开发部（蒋伟、冉正兴、刘巧宁、于险峰）、移动端平台部。
- 开发者：指 微应用的开发者，即业务模块的开发者，主要是刘巧宁的团队。
- 产品：

## 1.6 相关资料

[标品app前期分析文档](http://thoughts.hztianque.com/workspaces/5cbfc067be825b4f93d0fb70/docs/5e041a2b883c93000196ecd3)

[表单2.0设计分档](http://thoughts.hztianque.com/workspaces/5cbfc067be825b4f93d0fb70/docs/5e215b26883c93000197ec2b)

# 二、总体设计

## 2.1 我是什么，我能做什么

平安通标品是一个能够运行**微应用**的**网格化社会治理领域**的**安卓软件**，是展现**微应用**(综治业务逻辑)的主体和环境。

**以前**：有近70个不同版本平安通，每个平安通版本有10+以上的**业务模块**

**以后**：只有一个**平安通标品**，所有原先各版本中的业务模块转化为一个个的**微应用**，这些微应用将能够在平安通标品这个体系/框架下正常有序的运行。

平安通标品的设计方案将构建一个**标准而通用的开发体系**，为业务的开发者提供了一套**微应用开发SDK**，开发者能够基于该SDK，开发出能够运行在平安通标品中的**微应用**。

平安通标品将能够集成公共服务，转化成**端能力**，以RPC的形式提供给**微应用**。也支持开发者自行集成服务扩展端能力，还可以将微应用A的业务功能以端能力的方式提供给其他微应用B。

本方案，主要是设计平安通标品的宿主与框架部分，为**微应用**的开发提供了框架上的支持，该方案中采用了大量现有的技术成果和公共能力。具体的微应用的设计与开发工作，是在解决方案开发部的基线版本与其他产品的基线版本的项目中。

同时，为了满足有限情况下的定制化需求，平安通标品能够以插件的形式，来修改框架/宿主部分。

微应用的开发技术栈，目前主要有两种：多端框架(TQ-Prism)，插件（TQ-RePlugin）。另外，也会支持H5网页，ReactNative。

## 2.2 ······

## 2.3 质量属性

### 2.3.1 开发期质量属性

**可扩展性**

以前的平安通可扩展性较低，每有新需求、新模块，基本都需要走一遍完整的开发、发布的流程

平安通标品要较简单的增加新功能，又要保证移动端架构统一。所以进行了以下设计：将平安通标品的宿主与业务模块进行分离解藕。两个部分相对各自独立。

平安通标品作为基础平台，独立开发独立运营，动态加载插件和应用。

每个业务模块作为单个应用，独立开发，有自己的开发、上线、维护流程。

平安通标品中，需要有可扩展性的部分，做成插件，以插件的方式来达到可扩展性的要求

- 首页
- 支持切换主题风格：
    - 整体页面风格：主题风格就是主题的titlebar颜色、背景图资源、icon等
    - 标准UI组件：由该组件提供可选样式
- 平安通生命周期
- 通过工作台配置+应用接入系统，达成应用可扩展目的
    - 第三方应用开发与上架流程
- 通过服务总线，达成服务可扩展目的

**可复用性**

可复用性进行了三个层次的复用设计：

- 组件：组件是最小的复用单元，通常用于复用 一些具有共性的功能代码、控件，通常不包含业务逻辑，以开发期依赖（maven、npm）的形式使用，在运行期无法独立更新
    - 标准UI样式库
    - 路由
    - 数据存储
    - 网络请求
    - 图片展现
- 公共插件：插件是更大一些的复用单元，与业务无关的共性的功能，通常用于实现一些较复杂的能力，一般以SDK的形式提供能力给其他业务模块、应用使用，插件能够独立更新，通常有特定的服务后端。安卓原生开发，以内置插件或者外置插件的形式存在。
    - 视频通话
    - 鹰眼
    - H5容器
    - 移动端提交中心
- 微应用：业务应用，应用是实现具体业务逻辑的复用单元，直接对接了后端提供的接口，与后端强耦合。开发形式可以是多端可以是原生，通过应用接入子系统，运行在平安通标品的应用容器中。多端应用还能够运行在其他端上。
    - 矛盾纠纷
    - 人口采集
    - 房屋采集
    - 巡查走访

微应用应用的复用：

1. 微应用和宿主之间无代码依赖（开发期的代码import），转变为服务依赖（运行期的服务调用）。需要调用宿主的功能的部分，通过服务池来调用，在运行期来判断是否服务池中是否有需要的服务。
2. 微应用依赖于容器环境而运行，只要容器环境一致，微应用能够直接复用

**可移植性**

这里主要包含两块：

平安通标品的移植：主要是指平安通对于不同地区的综治后台的兼容性，基础业务数据差异部分通过BFF来隔离。

微应用的可移植性：由运行环境和具体微应用的开发技术栈的能力（如多端框架）决定。

**可维护性**

当需要修改缺陷、增加功能、提高质量属性时，定位修改点并实施修改的难易程度

定位问题的方式：日志采集

实施修改的方式：

- 插件更新
- 应用更新
- 平安通标品App更新

### 2.3.2 运行期质量属性

**性能**

集成无线云平台的性能监控服务-APM

**安全性**

后面可能需要考虑应用接入的安全性和插件更新的安全性，暂时不考虑这些。

目前仅借助一些现有的安全手段：

- 网关的接口加密
- 用户身份认证
- 用户权限认证
- 安卓app加壳、加固，防止非法篡改代码

**持续可用性**

断网、弱网下，不能出现App崩溃

应用的运行时异常不会导致平安通App崩溃

## 2.4 系统整体结构设计

![Untitled/Untitled.png](Untitled/Untitled.png)

## 2.5 网络结构图

基础业务数据BFF是为了能够适配可见的不同用户中心的情况，具体开发工作应该有标准化产品的团队负责。

![Untitled/Untitled%201.png](Untitled/Untitled%201.png)

## 2.6 细节功能思维导图

最初的思考要做的工作的思维导图，最后落到本方案的，主要是能力与page的部分。

主要是为了让平安通标品的方案更加专注于它自己的目标，去塑造一个标准而通用的开发体系。

很多本图中的功能，会以另外立项的形式去完成。

![Untitled.png](Untitled.png)

## 2.7 服务器资源需求说明

基础共性功能的服务器部分主要包含：

- 无线云平台：（4C 16G 300G），部署负责人：@邓杰
    - 安卓App升级管理
    - 安卓公共插件升级管理
    - H5应用升级管理
    - 微应用配置管理（工作台配置管理系统）
        - 由安卓插件方式开发的微应用，部署上架走无线云平台
        - 多端项目：并发不大的话，与无线云平台共用一台服务器。否则单独申请一台Nginx服务器:4C8G 200G
- ~~基础业务数据BFF：可暂时忽略~~
- 标准的网关：部署负责人：@卢玉龙

## 2.8 标品必须具备的基础端能力/Api

数据共享：

应用拉起：

## 2.9 微应用开发SDK

多端版：

插件版：

## 2.10 微应用开发调试流程

多端版：

插件版：

## 2.11 微应用上架部署流程

## 2.12 微应用之间交互的规范与流程

# 三、子系统

## 3.1 应用接入系统

这是为了让应用能够正常运行在平安通之中，主要包括了应用容器、应用与平安通平台的交互等部分功能。

无线云平台作为应用市场，提供能够运行在平安通中的应用，具体的配置工作见 **3.2 工作台配置子系统**

应用类型：多端项目、安卓原生插件

应用处于独立进程中运行，提高平安通平台的健壮性，应用崩溃不会导致平安通标品的崩溃。

应用的下载、升级等流程：使用现有的插件管理sdk。

![Untitled/Untitled%202.png](Untitled/Untitled%202.png)

## 3.2 工作台配置系统

### 3.2.1 后端部分

这是一个能够在后端对平安通的工作台页面中的应用进行管理、配置的功能。

- 发布应用、上架与下架应用、更新应用
    - 应用类型：多端、android插件
- 应用的字段
    - 基本信息：应用名字（中文- 显示给用户的应用名 + 英文 - 内部管理的应用项目名），图标icon
    - 应用主体：多端的webUrl，插件信息（关联到插件管理页面中的某个插件）
    - 对应的权限名字的字段
- 显示相关：应用的排序、分组
- 提供设置 应用配置参数的地方，目前已有

![Untitled/Untitled%203.png](Untitled/Untitled%203.png)

### 3.2.2 移动端部分

主要功能为工作台页面的展现，应用的展现。

- 展现工作台页面，通过缓存提高体验
- 工作台上的应用可以点击打开
    - 多端应用
    - 原生应用：原生应用还有本地缓存、应用版本更新和下载的功能与相关优化

## 3.3 LifeLine

平安通生命周期：需要解决什么问题？

为了解决不同地区私有化部署中，出现的网络接入方式不同，

1. 一般平安通的政务外网环境，自动切换apn

2. 浙江格尔、其他部分地市等需要开启vpn

3. 无需任何操作

这些事情触发的时机实在平安通app开启-> 用户登录之前。

为了避免在平安通标品app的宿主部分添加这种复杂的个性化功能处理，所以增加平安通生命周期的功能，通过发送广播/发送消息的形式，让某些插件接收到信号(即监听生命周期)后自己执行切换网络的功能。

优先级上：第一阶段仅为了实现解决方案开发部基线版本中的移动端部分，暂不开发该功能

扩展开，该能力可以用于实现 用户登录后到用户注销之前，自动开启轨迹采集等功能

主要就是为了避免在唯一的平安通标品app的宿主中，添加大量地区个性化业务

LifeLine- 生命线。

如果某地区期望能够在平安通app的使用中插入某一个功能

- 用户一登录，就开始日志采集(性能日志、轨迹信息、错误日志等)
- 用户登录前，就开启某一个功能(VPN、格尔等)
- 等等等等

为了解决这个问题

LifeLine就是 平安通App的使用过程中出现的生命周期

- App 开启
- 用户登录完成
- 用户注销登录
- App 暂停(jvm : stop the world)
- App 暂停恢复：检查线程情况、数据情况
- App 关闭

平安通标品将提供一个LifeLine的SDK 给业务应用开发者。业务应用开发者将开发完成的插件上传并申请完权限后，平安通标品将定时更新LifeLine的观察者列表，在触发LifeLine的阶段时，会将消息/通知发送给观察者列表中的每一个观察者。

限制：允许且仅允许以原生插件的方式来使用，且必须在无线云平台的插件管理页面进行设置—“自启动开关”

## 3.4 服务总线

目标：业务开发者可以自行提供服务给XX应用使用，提高可扩展性。

业务场景：

1. 宿主提供用户信息、组织机构信息等数据，提供给处于独立进程中运行的XX应用
2. 宿主提供apn设置能力，应用可以调用它来主动的开启、关闭apn
3. 宿主提供格尔Vpn能力，应用可以调用它来主动的开启、关闭vpn
4. 宿主提供视频通话功能，应用可以调用它与通讯里里的XX进行视频通话，通话结束后正确返回上一个页面
5. 宿主提供数据存储与提交中转，应用可以调用它，来实现采集数据的草稿箱存储和统一的数据上传流程（于宿主中发送请求，异步优化）
6. 无线云平台提供鹰眼服务，由宿主的开发者接入到宿主中，提供给业务小组做具体XX应用时可以调用到该功能。

对应需求：

1. 开发者（宿主开发小组、业务小组都可以）都可以注册服务
2. 应用可以调用服务
3. 每有新增服务，宿主不需要重新发布，应用不需要重新发布
4. 应用在开发、调试、生成环境下对服务调用的效果基本一致
    1. 由于应用是独立开发的，所以开发环境下不依赖宿主运行
    2. 多端应用以VSCode开发+浏览器调试，不运行在平安通标品宿主中
5. 当被调用服务不存在，不会出现异常崩溃
6. 

功能点：平安通平台对应用提供统一的服务调用方式

- 原生应用不能通过代码依赖的方式直接调用服务
- 应用通过集成一个SDK来调用服务
- 平安通平台的所有可被调用服务在 服务池进行聚合，统一对外（应用）暴露
- 大部分可被调用服务都是以插件的形式存在，可动态部署，例如视频通话、雪亮监控等
- 服务聚合-服务总线的概念：
    - 对内：聚合所有可被调用的服务，以一个标准化的方式进行服务注册
    - 对外-对应用：将服务暴露出去，以一个标准化的方式提供服务调用

![Untitled/Untitled%204.png](Untitled/Untitled%204.png)

将应用运行在独立进程中，进程分离的目的是：将应用分离到独立进程中，有效的增加了内存使用，避免了应用对主进程内存的占用导致的主进程服务异常；同时也通过这种独立进程方案避免了质量参差不齐的应用Crash影响主进程的运行。

两个进程间不能直接通信，所以通信方式要使用AIDL（参考）。

注册服务的代码调用示例：

    String serviceName= "accountService/getName";
    ServiceManager.registerService(serviceName,new ServiceImpl(){
    		public String serviceAction(){
    				return LocalAccountData.getAccount().getName();
    		}
    });

应用如何注册自己作为服务，也许需要一个为应用做一个专门的服务提供者来放到服务层。那么可以规范应用无法注册自己作为服务，需要为其量身定做一个插件来提高对应的服务，可以在这个服务中开启此应用。一般的应用之间互相拉起不需要如此麻烦，直接通过端能力即可。

## 3.5 数据交换格式

一般数据采用JSON格式传输

数据量较大的采用Protobuf格式进行传输： 

- 数据字典
- 权限

## 3.6 数据字典使用的性能优化方案

数据接口返回的数据交换格式从json转变为protobuf

### 对比与分析

将数据字典信息做以下对比：

将所有数据放入一个文件，压缩/不压缩的情况下，数据大小和转换成对象的时间

[数据字典 性能对比](https://www.notion.so/3654aa0934e84bc488c181152ef1204e)

### 应用的数据字典使用

**异步方式**

应用需要以异步的方式从平安通宿主处获得数据字典数据，平安通宿主会根据情况，从多级缓存（内存、本地数据库、网络）中查询数据并返回。由于是异步，所以每次使用都是异步回调，开发者的开发中会比较麻烦。

**同步方式**

应用在加载的时候，通过一个应用加载页，向宿主请求所有需要用到的数据字典，放入内存中，则后面所有的开发使用都可以用同步的方式来使用数据。

这里的问题是：

- 需要将当前应用所有会用到的数据字典的名字进行收集并汇总

目前考虑，以APT的形式，在编译器进行这些数据的收集，然后将这些数据放入应用的一个应用声明文件中。